<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="MapLesotho - Planning and OpenStreetMap project" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <title>With > 750,000 of them, where all the buildings at?</title>

    <meta name="description" content="So in this post the first in a series of little real world use cases of MapLesotho data, we’re going to be mapping building density in Lesotho.">

    <link rel="canonical" href="/blog/2017/06/18/building-density/">

    <link rel="author" type="text/plain" href="humans.txt" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="#MapLesotho" />
    <meta name="twitter:title" content="MapLesotho - Planning and OpenStreetMap project">
    <meta name="twitter:description" content="MapLesotho - Planning and OpenStreetMap project" />
    <meta name="twitter:image:src" content="http://www.maplesotho.com/assets/graphics/meta/default-meta-image.png" />
    <!--/ Twitter --> 

    <!-- OG -->
    <meta property="og:site_name" content="#MapLesotho - Planning and OpenStreetMap project" />
    <meta property="og:title" content="#MapLesotho - Planning and OpenStreetMap project" />
    <!-- <meta property="og:url" content="" /> -->
    <meta property="og:type" content="website" />
    <meta property="og:description" content="MapLesotho - Planning and OpenStreetMap project" />
    <meta property="og:image" content="http://www.maplesotho.com/assets/graphics/meta/default-meta-image.png" />
    <!--/ OG -->

    <link rel="shortcut icon" href="http://www.maplesotho.com/assets/graphics/meta/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="assets/graphics/meta/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/graphics/meta/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="http://www.maplesotho.com/assets/graphics/meta/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="http://www.maplesotho.com/assets/graphics/meta/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="http://www.maplesotho.com/assets/graphics/meta/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="http://www.maplesotho.com/assets/graphics/meta/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="http://www.maplesotho.com/assets/graphics/meta/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="http://www.maplesotho.com/assets/graphics/meta/apple-touch-icon-152x152.png" />

    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,700" />


    

    <link rel="stylesheet" href="/assets/styles/main-3d4d78346f.css">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

    <script type="text/javascript" src="https://widgets.wp.com/platform.js"></script>

    
    <script src="/assets/scripts/vendor-9a93b23e43.js"></script>
    
    <script src="/assets/scripts/bundle-048c897fa8.js"></script>

    <script type="text/javascript" src="/assets/scripts/jquery.min.js"></script>

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  </head>
  <body>
   <!--[if lt IE 11]>
      <div id="nocando">
        <h1>No can do!</h1>
        <p>You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
      </div>
    <![endif]-->


  <div class="p2y fill-lightgrey">
  
  	<div class="wrapper clearfix">
    <nav>
      <div class="col4">
  		<h1 class="page__title">
        <a href="/" title="Visit homepage">
          <span class="mast-logo mast-logo--h">
            <img src="/assets/graphics/layout/maplesotho-logo-pos.svg" alt="#MapLesotho logo" class="mast-logo__image" style="max-width: 180px;" />
            <!-- <strong class="mast-logo__text">MapLesotho</strong> -->
            <small class="mast-logo__label">Blog</small>
          </span>
        </a>
      </h1>   
      </div> 
      <div class="col8">
        <ul class="global-menu text-right">
          <li><a class="global-menu-item" href="/get-data/">Get the data</a></li>
          <li><a class="global-menu-item" href="/#dash">Dashboard</a></li>
          <li><a class="global-menu-item" href="https://stats.maplesotho.com/">Users</a></li>
          <li><a class="global-menu-item" href="/about/">About</a></li>
          <li><a class="global-menu-item" href="/blog/">Blog</a></li>
          <li><a class="global-menu-item" href="/videos/">Videos</a></li>
          <li><a class="global-menu-item" href="/weekly/">Weekly</a></li>
        </ul>
      </div>
      </nav>
  	</div>
  
  </div>

  <div class="wrapper clearfix">
	<div class="col8 m2 p4y">
		<h2>With > 750,000 of them, where all the buildings at?</h2>
		<p><small>18 June 2017</small> | <a href="http://www.openstreetmap.org/user/RustyB"><strong>RustyB</strong></a></p>	
		<div class="space-top2 p2y line-top prose prose-big">
			<p>So in this post the first in a series of little real world use cases of MapLesotho data, we’re going to be mapping building density in Lesotho.</p>

<p>For those not in the know that means we’re going to split lesotho into little parcels of a fixed size and then count the number of buildings within each parcel.</p>

<h2 id="assumptions">Assumptions</h2>

<p>We will make the following assumptions if you’re following along, that you’ve got:</p>

<ul>
  <li>a postgres database with postgis loaded.</li>
  <li>an export of Lesotho loaded in with <code class="highlighter-rouge">osm2pgsql</code></li>
</ul>

<p>The first thing we’re going to do is create a hexgon grid to cover the land area of Lesotho. Although we can do this in QGIS i’m going to show you how to easily create one in PostGIS.</p>

<p>Thankfully CartoDB has already made a super handy function for use to create on of these grid. You should run the code below in your osm database to add the <code class="highlighter-rouge">CDB_HexagonGrid()</code> function.</p>

<p><a href="https://github.com/CartoDB/cartodb-postgresql/blob/master/scripts-available/CDB_Hexagon.sql">Source</a> <a href="https://gist.github.com/rustyb/a9e266f1c3e96d0812609b5874c26322#file-cartodb-hexagon-grid-function-sql">Copy from this gist</a></p>

<p>Now we shall make our hexagon grid table and make one that matches the are of Lesotho.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- create our hexgrid table</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">hexgrid</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">hexgrid</span> <span class="p">(</span>
  <span class="n">gid</span>             <span class="n">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">cell</span>           <span class="n">geometry</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="c1">-- add the cells to the grid using lesotho admin boundary</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">hexgrid</span><span class="p">(</span><span class="n">way</span><span class="p">)</span>
  <span class="k">WITH</span>
 <span class="n">geo</span> <span class="k">as</span> <span class="p">(</span><span class="k">select</span> <span class="n">way</span> <span class="k">from</span> <span class="n">planet_osm_polygon</span> <span class="k">where</span> <span class="n">osm_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2093234</span><span class="p">),</span>
 <span class="n">grid</span> <span class="k">AS</span> <span class="p">(</span> <span class="k">SELECT</span> <span class="n">CDB_HexagonGrid</span><span class="p">(</span><span class="n">ST_Envelope</span><span class="p">(</span><span class="n">geo</span><span class="p">.</span><span class="n">way</span><span class="p">),</span> <span class="mi">2000</span><span class="p">)</span> <span class="k">AS</span> <span class="n">cell</span> <span class="k">from</span> <span class="n">geo</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">way</span> <span class="k">from</span> <span class="n">grid</span></code></pre></figure>

<p>And the result:</p>

<p><img src="https://s3.eu-central-1.amazonaws.com/ls-sat/blog-images/hexgrid/hexgrid.jpg" alt="" /></p>

<h2 id="building-density-per-grid-cell">Building Density per grid cell</h2>

<p>So next we’re going to do a little prepartory work to make our queries work a little faster when querying the buildings of Lesotho. There are &gt; 750,000 building in case you didn’t know.</p>

<p>First we will create a new table containing only buildings. You’ll notice we’re transforming our geomtetry, this is to allow us to take advantage of geography queries in later posts. We also get the centre point of the each polygon.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- get all the buildings into one table</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">buildings</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">buildings</span> <span class="k">as</span> <span class="p">(</span>
<span class="k">SELECT</span> <span class="n">osm_id</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">way_area</span><span class="p">,</span> <span class="n">ST_Transform</span><span class="p">(</span><span class="n">way</span><span class="p">,</span><span class="mi">4326</span><span class="p">)</span> <span class="k">as</span> <span class="n">way</span><span class="p">,</span> <span class="n">ST_Centroid</span><span class="p">(</span><span class="n">way</span><span class="p">)</span> <span class="k">as</span> <span class="n">centroid</span>
<span class="k">FROM</span> <span class="n">planet_osm_polygon</span> <span class="k">where</span> <span class="n">building</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span></code></pre></figure>

<p>Now to help our queries run much faster, we will create some spatial indexs on the geometry and osm_id columns. This may take a few minutes to run through.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- WE NEED TO MAKE THESE INDEXS SO THINGS RUN FASTER</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">buildings_index</span>
  <span class="k">ON</span> <span class="k">public</span><span class="p">.</span><span class="n">buildings</span>
  <span class="k">USING</span> <span class="n">gist</span>
  <span class="p">(</span><span class="n">way</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">buildings_centroid_index</span>
  <span class="k">ON</span> <span class="k">public</span><span class="p">.</span><span class="n">buildings</span>
  <span class="k">USING</span> <span class="n">gist</span>
  <span class="p">(</span><span class="n">centroid</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">buildings_pkey</span>
  <span class="k">ON</span> <span class="k">public</span><span class="p">.</span><span class="n">buildings</span>
  <span class="k">USING</span> <span class="n">btree</span>
  <span class="p">(</span><span class="n">osm_id</span><span class="p">);</span></code></pre></figure>

<p>Here’s a quick image of the buildings and their center points.</p>

<p><img src="https://s3.eu-central-1.amazonaws.com/ls-sat/blog-images/hexgrid/buildings.jpg" alt="center points" /></p>

<p>Now onto the fancy part we’re going to use some spatial joins to count how many centroid points are within each hexagon. Running the query below will add a now column to the hexgrid table for the building count.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">hexgrid</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">agg_building</span> <span class="n">float</span><span class="p">;</span> <span class="c1">--Add a column to the hexagon table</span>
<span class="k">UPDATE</span> <span class="n">hexgrid</span> <span class="k">SET</span> <span class="n">agg_building</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span> <span class="c1">--Initialize that column to a count of zero</span>
<span class="k">UPDATE</span> <span class="n">hexgrid</span> <span class="k">SET</span> <span class="n">agg_building</span> <span class="o">=</span> <span class="n">temporary_holder</span><span class="p">.</span><span class="n">building_count</span>
  <span class="k">FROM</span>
  <span class="p">(</span>
    <span class="k">SELECT</span>
      <span class="n">hexgrid</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span> <span class="c1">--Keep the ID for each hexagon to help specify which rows to update</span>
      <span class="k">count</span><span class="p">(</span> <span class="c1">--The aggregation function used in collapsing to just hexagons</span>
          <span class="n">buildings</span><span class="p">.</span><span class="n">osm_id</span> <span class="c1">--Just a vector of ones meaning yes if building</span>
          <span class="p">)</span> <span class="k">AS</span> <span class="n">building_count</span> <span class="c1">--Give the total a name for easy reference</span>
    <span class="k">FROM</span>
    <span class="p">(</span>
      <span class="n">hexgrid</span>
      <span class="k">INNER</span> <span class="k">JOIN</span> <span class="c1">-- Make a new table where each pair of hexagon-gazetteer point is a row</span>
      <span class="n">buildings</span>
      <span class="k">ON</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">hexgrid</span><span class="p">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">buildings</span><span class="p">.</span><span class="n">centroid</span><span class="p">)</span> <span class="c1">-- Only for pairs that occupy the same space</span>
    <span class="p">)</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">hexgrid</span><span class="p">.</span><span class="n">gid</span> <span class="c1">-- Collapse hexagon-gazetteer point pairs to just hexagons</span>
  <span class="p">)</span> <span class="k">AS</span> <span class="n">temporary_holder</span> <span class="c1">--The placeholder name for the aggregate results</span>
  <span class="k">WHERE</span> <span class="n">hexgrid</span><span class="p">.</span><span class="n">gid</span><span class="o">=</span><span class="n">temporary_holder</span><span class="p">.</span><span class="n">gid</span> <span class="c1">--Update rows in the hexagon table with matching id number</span></code></pre></figure>

<p><a href="http://rexdouglass.com/spatial-hexagon-binning-in-postgis/">Original Query - Rex Douglass</a></p>

<p>If we bring these layers into QGIS we can then visualise the results:</p>

<p><img src="https://s3.eu-central-1.amazonaws.com/ls-sat/blog-images/hexgrid/ml-bulding-densityw.jpg" alt="" /></p>

<p>You can see that the highest densities are surrounding the major settlements and in the north from Maseru to Bera, to Leribe, and Buthe-Buthe.</p>

<p><strong>Have an idea another idea of a #MapLesotho question we could answer with this technique, then let me know on twitter <a href="https://twitter.com/rusty1052">@Rusty1052</a></strong></p>

		</div>
	</div>
</div>

<div class="wrapper center p8x p4y post-actions">
	<a class="icon twitter" href="https://twitter.com/share?url=http://www.maplesotho.com/blog/2017/06/18/building-density/">Twitter</a>

	<a class="icon facebook" href="http://facebook.com/sharer.php?u=http://www.maplesotho.com/blog/2017/06/18/building-density/">Facebook</a>
	
	<a class="icon all" href="/blog/2017/06/06/keeping-an-eye-on-your-maplesotho-stats/">All</a>
  
  <a class="icon prev " href="/blog/2017/06/06/keeping-an-eye-on-your-maplesotho-stats/">Previous</a>

  <a class="icon next " href="/blog/2017/06/21/maplesotho-spreads-to-other-ministries/"> Next</a>
  

</div>

<script type="text/javascript" src="/assets/scripts/jquery.simulate.min.js"></script>
<script type="text/javascript">
$(document.documentElement).keyup(function (e) {
  if (e.keyCode == 39)
  {
    $( "a.home-next,li.next a,a.next" ).simulate( "click" );
  }
  if (e.keyCode == 37)
  {
    $( "a.home-prev,li.prev a,a.prev" ).simulate( "click" );
  }
});
</script>

  
  <div class="p4y fill-blue dark center line-bottom">
<div class="wrapper">
	<div class="p8x">
		<h2>Keep in touch </h2>
		<a href="https://www.facebook.com/groups/1539200169678837/?fref=nf" class="button icon facebook">Facebook</a> 
		<a href="https://twitter.com/search?q=%23MapLesotho&src=typd" class="button icon twitter">#MapLesotho</a> 
		<a href="http://wiki.openstreetmap.org/wiki/WikiProject_Lesotho" class="button icon twitter">OSM Wiki</a> 
	</div>
</div>
</div>

<footer class="p4y fill-lightgrey" >
    <div class="wrapper">
    	<div class="p8x">
    		<p>Made with love by <a href="https://cbroderick.me" title="Visit Colin Brodericks website">Colin Broderick</a> and <a href="http://fingal.ie/" title="Visit the Fingal County Council website">Fingal</a>, inspired by Development Seed and HotOSM.</p>
    	</div>
    </div>
</footer>

<!-- Get Gauges -->
<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '57c1d417c88d90366d024be9');
    t.setAttribute('data-track-path', 'https://track.gaug.es/track.gif');
    t.src = 'https://d36ee2fcip1434.cloudfront.net/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>

  <style type="text/css">
  	.item {min-height: 260px;}
  </style>

  

  </body>
</html>
